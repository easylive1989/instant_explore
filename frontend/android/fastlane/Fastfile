# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do
  desc "Build Android App Bundle (Release)"
  lane :build_release_aab do
    # åˆ‡æ›åˆ° Flutter å°ˆæ¡ˆæ ¹ç›®éŒ„
    Dir.chdir("../../") do
      # å»ºç½® Release AAB
      sh("fvm flutter build appbundle --release " +
         "--dart-define=GOOGLE_MAPS_API_KEY=#{ENV['GOOGLE_MAPS_API_KEY']} " +
         "--dart-define=SUPABASE_URL=#{ENV['SUPABASE_URL']} " +
         "--dart-define=SUPABASE_ANON_KEY=#{ENV['SUPABASE_ANON_KEY']} " +
         "--dart-define=GOOGLE_WEB_CLIENT_ID=#{ENV['GOOGLE_WEB_CLIENT_ID']} " +
         "--dart-define=GOOGLE_IOS_CLIENT_ID=#{ENV['GOOGLE_IOS_CLIENT_ID']}")
      
      UI.success("âœ… Android App Bundle å»ºç½®å®Œæˆï¼")
      UI.message("ğŸ“ AAB ä½ç½®: #{Dir.pwd}/build/app/outputs/bundle/release/app-release.aab")
    end
  end
  desc "Deploy Android App Bundle to Google Play Console Internal Track"
  lane :deploy_internal do
    # å»ºç«‹ service account é‡‘é‘°æª”æ¡ˆ
    service_account_key_content = ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']
    if service_account_key_content.nil? || service_account_key_content.empty?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is not set")
    end
    
    # å¯«å…¥ service account é‡‘é‘°åˆ°æª”æ¡ˆ
    key_file_path = File.expand_path("service-account-key.json")
    File.write(key_file_path, service_account_key_content)
    
    # ä¸Šå‚³ AAB åˆ° Google Play Console Internal Track
    upload_to_play_store(
      json_key: key_file_path,
      track: 'internal',
      release_status: 'draft',
      aab: '../build/app/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    
    # æ¸…ç† service account é‡‘é‘°æª”æ¡ˆ
    File.delete(key_file_path) if File.exist?(key_file_path)
    
    UI.success("âœ… Android App Bundle å·²æˆåŠŸä¸Šå‚³åˆ° Google Play Console Internal Trackï¼")
  end

  desc "Deploy Android App Bundle to Google Play Console Beta Track"
  lane :deploy_beta do
    # å»ºç«‹ service account é‡‘é‘°æª”æ¡ˆ
    service_account_key_content = ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']
    if service_account_key_content.nil? || service_account_key_content.empty?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is not set")
    end
    
    # å¯«å…¥ service account é‡‘é‘°åˆ°æª”æ¡ˆ
    key_file_path = File.expand_path("service-account-key.json")
    File.write(key_file_path, service_account_key_content)
    
    # ä¸Šå‚³ AAB åˆ° Google Play Console Beta Track
    upload_to_play_store(
      json_key: key_file_path,
      track: 'beta',
      aab: '../build/app/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    
    # æ¸…ç† service account é‡‘é‘°æª”æ¡ˆ
    File.delete(key_file_path) if File.exist?(key_file_path)
    
    UI.success("âœ… Android App Bundle å·²æˆåŠŸä¸Šå‚³åˆ° Google Play Console Beta Trackï¼")
  end

  desc "Deploy Android App Bundle to Google Play Console Production Track"
  lane :deploy_production do
    # å»ºç«‹ service account é‡‘é‘°æª”æ¡ˆ
    service_account_key_content = ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']
    if service_account_key_content.nil? || service_account_key_content.empty?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is not set")
    end
    
    # å¯«å…¥ service account é‡‘é‘°åˆ°æª”æ¡ˆ
    key_file_path = File.expand_path("service-account-key.json")
    File.write(key_file_path, service_account_key_content)
    
    # ä¸Šå‚³ AAB åˆ° Google Play Console Production Track
    upload_to_play_store(
      json_key: key_file_path,
      track: 'production',
      aab: '../build/app/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
    
    # æ¸…ç† service account é‡‘é‘°æª”æ¡ˆ
    File.delete(key_file_path) if File.exist?(key_file_path)
    
    UI.success("âœ… Android App Bundle å·²æˆåŠŸä¸Šå‚³åˆ° Google Play Console Production Trackï¼")
  end
end